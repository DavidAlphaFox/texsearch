<body id="body">
  <div><a href="javascript:parseGet()">Search</a></div>
  <textarea id="latex">$$\ifmmode\dot{V}\else\.\fi$$</textarea>

  <div>Results:</div>
  <div id="results"></div>

</body>

<script type='text/javascript' charset='utf-8'>
  var parseRequest = null;
  var indexRequest = null;
  var resultsRequest = null;
  var body = document.getElementById("body");
  var latex = document.getElementById("latex");
  var results = document.getElementById("results");

  function parseGet()
  {
    var url = "/documents/_external/parse?latex=" + escape(latex.value);

    parseRequest = new XMLHttpRequest();
    parseRequest.onreadystatechange = parseCallback;
    parseRequest.open("GET",url);
    parseRequest.send( null );
  }

  function parseCallback()
  {
    if (parseRequest.readyState == 4 && parseRequest.status == 200) {
      indexGet(parseRequest.responseText)
    } else if (parseRequest.readyState == 4 && parseRequest.status != 200) {
      results.textContent = "Error " + parseRequest.status + " : " + parseRequest.responseText
    }
  }

  function indexGet(latex)
  {
    var url = "/documents/_external/index?limit=10&cutoff=5&latex=" + escape(latex);

    indexRequest = new XMLHttpRequest();
    indexRequest.onreadystatechange = indexCallback;
    indexRequest.open("GET",url);
    indexRequest.send( null );
  }

  function indexCallback()
  {
    if (indexRequest.readyState == 4 && indexRequest.status == 200) {
      resultsGet(indexRequest.responseText)
    } else if (indexRequest.readyState == 4 && indexRequest.status != 200) {
      results.textContent = "Error " + indexRequest.status + " : " + indexRequest.responseText
    }
  }

  function resultsGet(ids)
  {
    var url = "/documents/_design/demo/_view/results";

    resultsRequest = new XMLHttpRequest();
    resultsRequest.onreadystatechange = resultsCallback;
    resultsRequest.open("POST",url);
    resultsRequest.send("{\"keys\":" + ids + "}");
  }

function resultsCallback()
  {
    if (resultsRequest.readyState == 4 && resultsRequest.status == 200) {
      response = eval("(" + resultsRequest.responseText + ")"); /* Yes, this is a bad thing to do */

      body.removeChild(results);
      results = document.createElement('div');
      function displayRow(row) {
        var p = document.createElement('p');
        p.textContent = row.value;
        results.appendChild(p)
      }
      response.rows.forEach(displayRow);
      body.appendChild(results);

    } else if (resultsRequest.readyState == 4 && resultsRequest.status != 200) {
      results.textContent = "Error " + resultsRequest.status + " : " + resultsRequest.responseText
    }
  }
</script>